let selectedCity = "";
let map;
let marker;       // ç›®çš„åœ°ãƒ”ãƒ³ï¼ˆèµ¤ï¼‰
let startMarker;  // å‡ºç™ºåœ°ãƒ”ãƒ³ï¼ˆé’ï¼‰
let startLat;
let startLng;
const HIGHWAY_SPEED = 80;
const LOCAL_SPEED = 40;
const TOKYO_STATION_POSITION = {
        center: { lat: 35.681236, lng: 139.767125 }, // æ±äº¬é§…
        zoom: 12,
        gestureHandling: "cooperative"
    }

// ===============================
// Google Map åˆæœŸè¡¨ç¤º
// ===============================
function initMap() {
    map = new google.maps.Map(document.getElementById("map"),TOKYO_STATION_POSITION);
}

// ===============================
// ãƒ©ãƒ³ãƒ€ãƒ åœ°ç‚¹é–‹å§‹ï¼
// ===============================
function searchSpot() {

    const startAddress = document.getElementById("startLocation").value;

    if (!startAddress) {
        alert("å‡ºç™ºåœ°ã‚’å…¥åŠ›ã—ã¦ã­ï¼");
        return;
    }

    const time = Number(document.getElementById("timeSelect").value);
    const highway = document.getElementById("highway").value;

    const geocoder = new google.maps.Geocoder();

    geocoder.geocode({ address: startAddress }, function (results, status) {

        if (status !== "OK" || !results[0]) {
            alert("å‡ºç™ºåœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ");
            return;
        }

        // ğŸ”¥ ã“ã‚ŒãŒå¿…è¦
        const startLat = results[0].geometry.location.lat();
        const startLng = results[0].geometry.location.lng();

        const maxDistance = maxDistanceByTime(time, highway);

        findValidPoint(startLat, startLng, maxDistance, geocoder, time, highway);;

        // é€†ã‚¸ã‚ªã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
        geocoder.geocode(
            { location: { lat: point.lat, lng: point.lng } },
            function (results, status) {

                let prefecture = "";
                let city = "";

                if (status === "OK" && results[0]) {

                    for (const comp of results[0].address_components) {

                        if (comp.types.includes("administrative_area_level_1")) {
                            prefecture = comp.long_name;
                        }

                        if (
                            comp.types.includes("locality") ||
                            comp.types.includes("administrative_area_level_2")
                        ) {
                            city = comp.long_name;
                        }
                    }
                }

                document.getElementById("result").innerHTML =
                    `<h2 style="color:red;">${prefecture}${city}</h2>
                     ğŸš—ç´„${distance.toFixed(1)}km<br>
                     â± ${time}åˆ† / ğŸ›£ ${highway === "yes" ? "é«˜é€Ÿã‚ã‚Š" : "ä¸‹é“ã®ã¿"}`;

                moveToNearestLand(point.lat, point.lng, function(newLat, newLng) {
                showMap(newLat, newLng);
                });
            }
        );
    });
}

// ===============================
// ãƒ©ãƒ³ãƒ€ãƒ åœ°ç‚¹ç”Ÿæˆï¼ˆè·é›¢å†…ï¼‰
// ===============================
function createRandomPoint(lat, lng, maxDistanceKm) {
    const radiusInDegrees = maxDistanceKm / 111;

    const u = Math.random();
    const v = Math.random();
    const w = radiusInDegrees * Math.sqrt(u);
    const t = 2 * Math.PI * v;

    const newLat = lat + w * Math.cos(t);
    const newLng = lng + w * Math.sin(t) / Math.cos(lat * Math.PI / 180);

    return { lat: newLat, lng: newLng };
}

// ===============================
// åœ°å›³æ›´æ–°ï¼ˆãƒ”ãƒ³1æœ¬ï¼‰
// ===============================
function showMap(lat, lng) {
    map.setCenter({ lat, lng });

    if (marker) marker.setMap(null);

    marker = new google.maps.Marker({
        position: { lat, lng },
        map: map,
        icon: {
            url: "dog.png",
            scaledSize: new google.maps.Size(60, 60)
        }
    });
}

// ===============================
// æ™‚é–“ â†’ è·é›¢è¨ˆç®—
// ===============================
function maxDistanceByTime(time, highway) {
    const hours = time / 60;

    let speed;
    if (highway === "yes") {
        speed = HIGHWAY_SPEED; // é«˜é€Ÿã‚ã‚Š
    } else {
        speed = LOCAL_SPEED; // ä¸‹é“ã®ã¿
    }

    return hours * speed;
}

// ===============================
// è·é›¢è¨ˆç®—ï¼ˆkmï¼‰
// ===============================
function calcDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // åœ°çƒåŠå¾„ï¼ˆkmï¼‰
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;

    const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) *
        Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng / 2) * Math.sin(dLng / 2);

    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function getPrefCity(lat, lng) {
  const geocoder = new google.maps.Geocoder();
  const latlng = { lat: lat, lng: lng };

  geocoder.geocode({ location: latlng }, function(results, status) {
    if (status === "OK") {
      if (results[0]) {

        let pref = "";
        let city = "";

        results[0].address_components.forEach(function(component) {

          if (component.types.includes("administrative_area_level_1")) {
            pref = component.long_name;   // éƒ½é“åºœçœŒ
          }

          if (
            component.types.includes("locality") ||
            component.types.includes("administrative_area_level_2")
          ) {
            city = component.long_name;   // å¸‚ç”ºæ‘
          }

        });

        document.getElementById("results").innerText =
          pref + city;
      }
    }
  });
}

// ===============================
// æ™‚é–“ãŒ30åˆ†ã®ã¨ãé«˜é€Ÿã‚’ç„¡åŠ¹åŒ–
// ===============================
function updateHighwayControl() {
    const time = document.getElementById("timeSelect").value;
    const highwaySelect = document.getElementById("highway");

    if (time === "30") {
        highwaySelect.value = "no";     // ä¸‹é“ã®ã¿å›ºå®š
        highwaySelect.disabled = true;  // é¸æŠä¸å¯
    } else {
        highwaySelect.disabled = false; // é¸æŠå¯èƒ½ã«æˆ»ã™
    }
}

// æ™‚é–“å¤‰æ›´æ™‚ã«ç™ºå‹•
document.getElementById("timeSelect")
    .addEventListener("change", updateHighwayControl);

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚‚ãƒã‚§ãƒƒã‚¯
window.addEventListener("load", updateHighwayControl);

// ===============================
// æµ·ã‚’é¿ã‘ã¦æœ‰åŠ¹åœ°ç‚¹ã‚’æ¢ã™
// ===============================
function findValidPoint(startLat, startLng, maxDistance, geocoder, time, highway, attempt = 0) {

    if (attempt > 15) {
        alert("æµ·ã«å½“ãŸã£ã¦ã—ã¾ã„ã¾ã—ãŸã€ã‚‚ã†ä¸€åº¦å›ã—ã¦ãã ã•ã„_(._.)_");
        return;
    }

    const point = createRandomPoint(startLat, startLng, maxDistance);

    geocoder.geocode(
        { location: { lat: point.lat, lng: point.lng } },
        function (results, status) {

            if (status === "OK" && results[0]) {

                let prefecture = "";
                let city = "";

                for (const comp of results[0].address_components) {

                    if (comp.types.includes("administrative_area_level_1")) {
                        prefecture = comp.long_name;
                    }

                    if (
                        comp.types.includes("locality") ||
                        comp.types.includes("administrative_area_level_2")
                    ) {
                        city = comp.long_name;
                    }
                }

                // éƒ½é“åºœçœŒãŒå–ã‚Œã‚Œã°OKï¼ˆï¼æµ·ã˜ã‚ƒãªã„å¯èƒ½æ€§é«˜ã„ï¼‰
                if (prefecture) {

                    const distance = calcDistance(startLat, startLng, point.lat, point.lng);

                    document.getElementById("result").innerHTML =
                        `<h2 style="color:red;">${prefecture}${city}</h2>
                         ğŸš—ç´„${distance.toFixed(1)}km<br>
                         â± ${time}åˆ† / ğŸ›£ ${highway === "yes" ? "é«˜é€Ÿã‚ã‚Š" : "ä¸‹é“ã®ã¿"}`;
                        showResultWithEffect();

                    showMap(point.lat, point.lng);
                    return;
                }
            }

            // ãƒ€ãƒ¡ãªã‚‰å†ãƒãƒ£ãƒ¬ãƒ³ã‚¸
            findValidPoint(startLat, startLng, maxDistance, geocoder, time, highway, attempt + 1);
        }
    );
}

// ===============================
// æµ·ã ã£ãŸã‚‰è¿‘ãã®é™¸åœ°ã«è£œæ­£
// ===============================
function moveToNearestLand(lat, lng, callback) {

    const service = new google.maps.places.PlacesService(map);

    service.nearbySearch(
        {
            location: { lat: lat, lng: lng },
            radius: 3000, // 3kmä»¥å†…ã‚’æ¤œç´¢
        },
        function (results, status) {

            if (status === google.maps.places.PlacesServiceStatus.OK && results[0]) {
                const landLocation = results[0].geometry.location;
                callback(landLocation.lat(), landLocation.lng());
            } else {
                // è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°ãã®ã¾ã¾
                callback(lat, lng);
            }
        }
    );
}

// ===============================
// è»Šã§åˆ°é”å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
// ===============================
function isReachableByRoad(startLat, startLng, targetLat, targetLng, callback) {

    const directionsService = new google.maps.DirectionsService();

    directionsService.route(
        {
            origin: { lat: startLat, lng: startLng },
            destination: { lat: targetLat, lng: targetLng },
            travelMode: google.maps.TravelMode.DRIVING,
        },
        function (result, status) {
            if (status === "OK") {
                callback(true);
            } else {
                callback(false);
            }
        }
    );
}

function showResultWithEffect() {
  const box = document.getElementById("resultsBox");

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚»ãƒƒãƒˆ
  box.classList.remove("show");
  void box.offsetWidth;

  box.classList.add("show");

  launchConfetti();
}

function launchConfetti() {
  const colors = ["#ff7675", "#74b9ff", "#55efc4", "#ffeaa7", "#a29bfe"];

  for (let i = 0; i < 40; i++) {
    const confetti = document.createElement("div");
    confetti.classList.add("confetti");

    confetti.style.left = Math.random() * 100 + "vw";
    confetti.style.backgroundColor =
      colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDuration = 2 + Math.random() * 2 + "s";

    document.body.appendChild(confetti);

    setTimeout(() => {
      confetti.remove();
    }, 4000);
  }
}